<script>
  const template = require("../js/template.js");
  const electron = require("electron");
  if (!localStorage.getItem("token")) {
    window.location = "../windows/login.html";
  }

  var title = `Welcome to CPM`;
  var head = `
  

  
  `;
  var body = `
<p></p>
`;

  template.createPage(title, head, body);
</script>
    <link rel="stylesheet" href="../assets/configurable/custom.css">

<script>
  var sevmax = 0;
  function removeElement(elementId) {
    // Removes an element from the document
    var element = document.getElementById(elementId);
    element.parentNode.removeChild(element);
  }
  var md5 = require("md5");
  var os = require('os');
  var obj;
  var email;
  var username;
  if (!localStorage.getItem("token")) {
    window.location = "../windows/login.html";
  }
  console.log("%cWARNING!!!", "font-size: 40px; color: RED");
  console.log(
    "%cnever tell anyone your password or token,\nwe would never message you asking for your password or token.",
    "font-size: 20px; color: #FA34B5"
  );
  var stuff =
    "https://csoftware.cf/api/api1.php?key=grUs07Md3s4o9WIb7fi3vu0AGdjinGP8BvFFSvcNI6viEkXFhNY9ZODlNnNWMXfaapeb20NbVBadZtwH9kFUnOgPXn8oWuPPnqJL&function=UAC&token=" +
    localStorage.getItem("token");
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function () {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("preloader").style = "display: none;";
      obj = JSON.parse(this.responseText);
      console.log(obj);
      window.title = "Welcome to CPM " + obj.username;
      document.getElementById("usernametext").innerHTML = obj.username;
      document.getElementById("pfp").src =
        "https://www.gravatar.com/avatar/" + md5(obj.email) + "?s=60";
              document.getElementById("bio").innerHTML = obj.bio;
                document.getElementById("l1-968b").style = "display: none;";
    }
    const fs = require('fs');
    function readFile(filepath) {
      fs.readFile(filepath, 'utf-8', function (err, data) {
        if (err) {
          alert("An error ocurred reading the file :" + err.message);
          return;
        }
        document.getElementById("customcss").innerHTML = data;
      });
    }
    readFile(__dirname + "\\../assets/configurable/custom.css");

  };
  xhttp.open("GET", stuff, true);
  xhttp.send();





</script>

<script>
  function removeElement(elementId) {
    // Removes an element from the document
    var element = document.getElementById(elementId);
    element.parentNode.removeChild(element);
  }
  var md5 = require("md5");
  var obj;
  var email;
  var username;
  if (!localStorage.getItem("token")) {
    window.location = "../windows/login.html";
  }

  function devmode() {
    console.log("Dev mode activated goto settings then UITEST.");
    document.getElementById("uitest").style.display = "block";
  }
</script>

<div class="sidenav">
  <img id="pfp" ></img><p class="usernametextblock" id="usernametext"></p>
  <a class="activation" id="chatoblock" onclick='sectiondiv(event, "chats","#ec6ead","#3494e6")' >chats</a>
  <a class="activation" onclick='sectiondiv(event, "settings","#00a2ff","#ab34e6")' >settings</a>
  <a class="activation" >call history</a>
  <p>Server List</p>
  <div id="chatsnav">

  </div>
</div>

<div class="main" id="chats" >
  <h2>Chats</h2>
  <input type="text" id="serverjoininputbox" placeholder="server invite code" />
  <button class="btn btn-success" onclick="joinserver()" height="90px" width="90px">Join server</button>

    <button id="create_btn" class="btn btn-info">Create server</button>
<div class="loading" id="preloader"></div>
<!-- The Modal -->
<div id="create" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <div class="modal-header bg-primary">
      <span class="close">&times;</span>
      <h2>Create CPM server using cpm direct</h2>
    </div>
    <div class="modal-body">
      <form action="#">
        <input id="servername" type="text" placeholder="Server Name" />
        <button class="btn btn-info">Create</button>
      </form>
    </div>
  </div>

</div>
</div>

<div class="main" id="settings">
  <h2>Settings</h2>


  <textarea disabled id="bio" ></textarea>
  <button class="btn btn-success" onclick="refreshprofile();">Refresh<img src="../assets/images/sysload.gif" id="l1-968b" style="display:none;" width="20px"/></button>


    <p>Custom CSS</p>
    <textarea id="customcss"></textarea>


    <button onclick="savecss();" class="btn btn-primary">apply custom css to file<img src="../assets/images/sysload.gif" id="l1-968c" style="display:none;" width="20px" /></button>
 

   

  <p>Client settings:</p>

  <button class="btn btn-danger" onclick="logout();">Logout</button>
  <button onclick="listgroups();" class="btn">Refresh server list</button>

  <a id="uitest" style="display: none;" class="btn btn-success" href="../windows/uitest.html">UITEST</a>


  <p>SERVER (Windows Only)</p>
    <button onclick="startserver();" class="btn btn-info">start CPM server direct</button>
</div>


<div id="chatsitem">


</div>




<script>


function logout(){
          var logout = new Audio("../assets/sounds/mp3-converted/logout.mp3");
  logout.play();
           setTimeout(function () {
             localStorage.clear();
             window.location = "../windows/login.html";
  }, 1000);

}

  document.getElementById("chatoblock").click();
  function sectiondiv(evt, sectiondiv, colour1,colour2) {
  

    document.getElementById("body").style = `background-image: linear-gradient( to right, ${colour1},${colour2});  transition: background-image 3s ease-in;`;    

    // Declare all variables
    var i, tabcontent, tablinks;

    // Get all elements with class="tabcontent" and hide them
    tabcontent = document.getElementsByClassName("main");
    for (i = 0; i < tabcontent.length; i++) {
      tabcontent[i].style.display = "none";
    }

    // Get all elements with class="tablinks" and remove the class "active"
    tablinks = document.getElementsByClassName("activation");
    for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the current tab, and add an "active" class to the button that opened the tab
    document.getElementById(sectiondiv).style.display = "block";
    evt.currentTarget.className += " active";

  } 

      const fs = require('fs');
  function refreshprofile(){
        var refresh = new Audio("../assets/sounds/mp3-converted/noti2.mp3");
    refresh.play();
      document.getElementById("l1-968b").style.display = "block";
    var stuff =
      "https://csoftware.cf/api/api1.php?key=grUs07Md3s4o9WIb7fi3vu0AGdjinGP8BvFFSvcNI6viEkXFhNY9ZODlNnNWMXfaapeb20NbVBadZtwH9kFUnOgPXn8oWuPPnqJL&function=UAC&token=" +
      localStorage.getItem("token");
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      console.log(stuff);

      if (this.readyState == 4 && this.status == 200) {
          
          setTimeout(function (){
            document.getElementById("l1-968b").style.display = "none";
               document.getElementById("preloader").style = "display: none;";
          }, 1000);
        obj = JSON.parse(this.responseText);
        console.log(obj);
        window.title = "Welcome to CPM " + obj.username;
        document.getElementById("pfp").src =
          "https://www.gravatar.com/avatar/" + md5(obj.email) + "?s=60";
        document.getElementById("bio").innerHTML = obj.bio;
      }
    };
    xhttp.open("GET", stuff, true);
    xhttp.send();
  }

    function savecss(){
              var refresh = new Audio("../assets/sounds/mp3-converted/noti3.mp3");
      refresh.play();
         document.getElementById("l1-968c").style.display = "block";
      console.log();
      const data = new Uint8Array(Buffer.from(document.getElementById("customcss").value));
      fs.writeFile(__dirname + "\\../assets/configurable/custom.css", data, (err) => {
        if (err) console.log(err);
        console.log('The file has been saved!');
        
        setTimeout(function () {

        location.reload();

        }, 1000);
      });
    
  }


  function joinserver(){

    if(sevmax == 100) return;
    var random = Math.random(1,99999999999);


    
    document.getElementById("chatsnav").innerHTML += `  <a id="btn_${random}" class="activation" onclick='sectiondiv(event, "win_${random}","#00a2ff","#ab34e6")' ></a>`;
    document.getElementById("chatsitem").innerHTML += 
    `
    <div class="main" id="win_${random}">
    <div><h2> </h2><button class="btn btn-danger" style="width: 90px;">Leave</button></div>

    <div class="msg-container" id="${random}_container">

    </div>

      <input type="text" placeholder="Message" id="textbox_${random}"/>

</div>
    
    `;
      sevmax += 1;

  }


function listgroups(){
   document.getElementById("chatsnav").innerHTML ="";
   document.getElementById("chatsitem").innerHTML = "";
        var stuff =
              "https://csoftware.cf/api/api1.php?key=grUs07Md3s4o9WIb7fi3vu0AGdjinGP8BvFFSvcNI6viEkXFhNY9ZODlNnNWMXfaapeb20NbVBadZtwH9kFUnOgPXn8oWuPPnqJL&function=listgroups&token=" +
              localStorage.getItem("token");
              console.log(stuff);
            var sl = new XMLHttpRequest();
            sl.onreadystatechange = function () {
              if (this.readyState == 4 && this.status == 200) {
                obj = JSON.parse(this.responseText);
                console.log(obj);
                obj.forEach(function(data,index){
                    var random = Math.random(1, 99999999999);
                    var randomColor = Math.floor(Math.random() * 16777215).toString(16);
                  var randomColortwo = Math.floor(Math.random() * 16777215).toString(16);
                  console.log(data);
                      document.getElementById("chatsnav").innerHTML += `<a class="font-size: 10vw" id="btn_${random}" class="activation" onclick='sectiondiv(event, "win_${random}","#${randomColor}","#${randomColortwo}")' >${data.name}</a>`;
                
                    document.getElementById("chatsitem").innerHTML +=
                    `
    <div class="main" id="win_${random}">
    <div><h2>${data.name}</h2><button class="btn btn-danger" style="width: 90px;">Leave</button></div>

    <div class="msg-container" id="${random}_container">

    </div>

      <input type="text" placeholder="Message" id="textbox_${random}"/>

</div>
    
    `;
                
                
                });
    }
  }

    sl.open("GET", stuff, true);
  sl.send();

}
listgroups();
</script>




<!-- Trigger/Open The Modal -->


<!-- The Modal -->
<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <span class="close">&times;</span>
    <p>Some text in the Modal..</p>
  </div>

</div>
    <script src="../js/Core.js"></script>